<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Eldora - Multi-Profile App</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* Global Styles */
    body {
      background-image: linear-gradient(to right, #a1c4fd, #c2e9fb);
      font-family: 'Inter', sans-serif;
    }
    .nav-btn {
      background-color: transparent;
      color: white;
      border: 1px solid rgba(255,255,255,0.5);
      transition: background-color 0.2s;
    }
    .nav-btn.active {
      background-color: rgba(255,255,255,0.3);
    }
    .nav-btn:hover {
      background-color: rgba(255,255,255,0.2);
    }
    .btn-primary {
      background-color: #4a90e2;
      color: white;
    }
    .btn-primary:hover {
      background-color: #3a78c2;
    }
    .card {
      background: #f7f7f7;
      border-radius: 0.5rem;
      box-shadow: 0 10px 15px rgba(0,0,0,0.1);
    }
    input[type="text"],
    input[type="number"],
    input[type="time"],
    input[type="file"] {
      background-color: #f7f7f7;
      padding: 0.75rem 1rem;
      font-size: 1rem;
    }
    .log-entry {
      padding: 0.75rem;
      background: white;
      border-left: 4px solid;
      margin-bottom: 0.5rem;
      border-radius: 0.25rem;
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }
    .log-success { border-color: #10b981; }
    .log-danger { border-color: #ef4444; }
  </style>
</head>
<body class="min-h-screen">
  <!-- Landing Page -->
  <div id="landingPage" class="flex items-center justify-center h-screen">
    <div class="text-center">
      <h1 class="text-5xl font-bold mb-8">Welcome to Eldora</h1>
      <p class="text-xl mb-8">Select Your Profile</p>
      <div class="space-x-4">
        <button id="selectCaregiver" class="bg-blue-600 text-white px-6 py-3 rounded">Caregiver</button>
        <button id="selectElder" class="bg-green-600 text-white px-6 py-3 rounded">Elder</button>
      </div>
    </div>
  </div>

  <!-- Caregiver Profile -->
  <div id="caregiverProfile" class="hidden">
    <!-- Caregiver Navigation -->
    <nav class="p-4 bg-blue-600">
      <div class="max-w-4xl mx-auto flex space-x-4">
        <button class="caregiver-nav-btn nav-btn text-white font-semibold px-4 py-2 rounded active" data-page="cgHome">Home</button>
        <button class="caregiver-nav-btn nav-btn text-white font-semibold px-4 py-2 rounded" data-page="cgMedicine">Medicine Reminder</button>
        <button class="caregiver-nav-btn nav-btn text-white font-semibold px-4 py-2 rounded" data-page="cgSafety">Safety Zone</button>
        <button class="caregiver-nav-btn nav-btn text-white font-semibold px-4 py-2 rounded" data-page="cgProfile">Profile</button>
        <button id="cgLogout" class="ml-auto bg-red-500 text-white px-4 py-2 rounded">Logout</button>
      </div>
    </nav>
    <div class="max-w-4xl mx-auto p-6">
      <!-- Caregiver Pages -->
      <div id="cgHome" class="cg-page">
        <h2 class="text-3xl font-bold mb-4">Caregiver Home</h2>
        <p>Welcome to your dashboard. Manage your app features from here.</p>
      </div>
      <div id="cgMedicine" class="cg-page hidden">
        <h2 class="text-3xl font-bold mb-4">Medicine Reminder</h2>
        <!-- Medicine Reminder Form -->
        <div class="card p-6 rounded-lg shadow-md mb-8">
          <h3 class="text-2xl font-semibold text-gray-700 mb-4 border-b pb-2">Set Medicine Reminder</h3>
          <form id="medicineFormCG" class="space-y-4">
            <div>
              <label for="medicineNameCG" class="block text-gray-600 font-medium">Medicine Name</label>
              <input type="text" id="medicineNameCG" name="medicineNameCG" placeholder="e.g. Paracetamol" required />
            </div>
            <div>
              <label for="pillCountCG" class="block text-gray-600 font-medium">Pills per Dose</label>
              <input type="number" id="pillCountCG" name="pillCountCG" placeholder="e.g. 2 pills" min="1" required />
            </div>
            <div>
              <label for="frequencyCG" class="block text-gray-600 font-medium">Frequency (Days)</label>
              <input type="number" id="frequencyCG" name="frequencyCG" min="1" max="365" value="3" required />
            </div>
            <div>
              <label class="block text-gray-600 font-medium">
                <input type="checkbox" id="lifetimeCG" class="mr-2"> Lifetime Medication
              </label>
            </div>
            <!-- Image Upload Field -->
            <div>
              <label for="medicineImagesCG" class="block text-gray-600 font-medium">Upload Medicine Image(s)</label>
              <input type="file" id="medicineImagesCG" name="medicineImagesCG" accept="image/*" multiple />
            </div>
            <div>
              <label class="block text-gray-600 font-medium mb-2">Set Alarm Time(s)</label>
              <div id="timeSlotsCG" class="space-y-2">
                <div class="flex space-x-2 items-center time-slot">
                  <input type="time" class="startTime rounded-md border-gray-300 shadow-sm" required />
                  <span class="self-center">to</span>
                  <input type="time" class="endTime rounded-md border-gray-300 shadow-sm" required />
                  <button type="button" class="removeTimeSlot bg-red-500 text-white px-2 py-1 rounded hover:bg-red-600">Remove</button>
                </div>
              </div>
              <button type="button" id="addTimeSlotCG" class="mt-2 bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">Add Time Slot</button>
            </div>
            <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">Set Reminder</button>
          </form>
        </div>
        <div class="card bg-white p-6 rounded-lg shadow-md mb-8">
          <h3 class="text-2xl font-semibold text-gray-700 mb-4">Active Medicine Reminders</h3>
          <div id="caregiverRemindersList">
            <p class="text-gray-500">No reminders set yet.</p>
          </div>
        </div>
        <div class="card bg-white p-6 rounded-lg shadow-md">
          <h3 class="text-2xl font-semibold text-gray-700 mb-4">Activity Log</h3>
          <div id="activityLogCG" class="space-y-2 max-h-96 overflow-y-auto">
            <p class="text-gray-500 text-sm">No activities yet.</p>
          </div>
        </div>
      </div>
      <div id="cgSafety" class="cg-page hidden">
        <h2 class="text-3xl font-bold mb-4">Safety Zone</h2>
        <p>This is the Safety Zone page. Here you can access emergency contacts, safety tips, and location-based features.</p>
      </div>
      <div id="cgProfile" class="cg-page hidden">
        <h2 class="text-3xl font-bold mb-4">Profile</h2>
        <p>Manage your personal details and settings here.</p>
      </div>
    </div>
  </div>

  <!-- Elder Profile -->
  <div id="elderProfile" class="hidden">
    <!-- Elder Navigation -->
    <nav class="p-4 bg-green-600">
      <div class="max-w-4xl mx-auto flex space-x-4">
        <button class="elder-nav-btn nav-btn text-white font-semibold px-4 py-2 rounded active" data-page="elHome">Home</button>
        <button class="elder-nav-btn nav-btn text-white font-semibold px-4 py-2 rounded" data-page="elMedicine">Medicine Reminder</button>
        <button class="elder-nav-btn nav-btn text-white font-semibold px-4 py-2 rounded" data-page="elSafety">Safety Zone</button>
        <button class="elder-nav-btn nav-btn text-white font-semibold px-4 py-2 rounded" data-page="elProfile">Profile</button>
        <button id="elLogout" class="ml-auto bg-red-500 text-white px-4 py-2 rounded">Logout</button>
      </div>
    </nav>
    <div class="max-w-4xl mx-auto p-6">
      <!-- Elder Pages -->
      <div id="elHome" class="el-page">
        <h2 class="text-3xl font-bold mb-4">Elder Home</h2>
        <p>Welcome to your dashboard. Here you can view your medicine reminders and safety information.</p>
      </div>
      <div id="elMedicine" class="el-page hidden">
        <h2 class="text-3xl font-bold mb-4">Medicine Reminder</h2>
        <div class="card bg-white p-6 rounded-lg shadow-md">
          <div id="elderRemindersList" class="overflow-x-auto">
            <p class="text-gray-500">No reminders available.</p>
          </div>
        </div>
      </div>
      <div id="elSafety" class="el-page hidden">
        <h2 class="text-3xl font-bold mb-4">Safety Zone</h2>
        <p>Access safety tips, emergency contacts, and location-based safety features here.</p>
      </div>
      <div id="elProfile" class="el-page hidden">
        <h2 class="text-3xl font-bold mb-4">Profile</h2>
        <p>View and update your personal details here.</p>
      </div>
    </div>
  </div>

  <script>
    // Global state (for demo, caregiver and elder share the same reminders)
    let remindersCG = [];
    let logEntriesCG = [];
    let remindersEL = [];

    // -----------------------
    // Caregiver Functionality
    // -----------------------
    document.addEventListener('DOMContentLoaded', function() {
      const caregiverForm = document.getElementById('medicineForm');
      const frequencyInput = document.getElementById('frequency');
      const lifetimeCheckbox = document.getElementById('lifetime');
      const timeSlotsDiv = document.getElementById('timeSlots');

      function timeToMinutes(timeStr) {
        const [h, m] = timeStr.split(':').map(Number);
        return h * 60 + m;
      }

      // Calculate evenly distributed alarm times with remainder distribution.
      function calculateAlarmTimes(start, end) {
        const startM = timeToMinutes(start);
        const endM = timeToMinutes(end);
        const duration = endM - startM;
        const base = Math.floor(duration / 3);
        const remainder = duration % 3;
        const firstAlarm = startM + base + (remainder >= 1 ? 1 : 0);
        const secondAlarm = firstAlarm + base + (remainder === 2 ? 1 : 0);
        const thirdAlarm = endM;
        return [firstAlarm, secondAlarm, thirdAlarm];
      }

      function formatDelay(minutes) {
        const hours = Math.floor(minutes / 60);
        const remaining = minutes % 60;
        let parts = [];
        if (hours > 0) parts.push(`${hours} hour${hours === 1 ? '' : 's'}`);
        if (remaining > 0) parts.push(`${remaining} minute${remaining === 1 ? '' : 's'}`);
        return parts.join(' ') + ' late';
      }

      caregiverForm.addEventListener('submit', function(e) {
        e.preventDefault();
        const medicineName = document.getElementById('medicineName').value;
        const pillCount = document.getElementById('pillCount').value;
        const frequency = lifetimeCheckbox.checked ? "Life" : frequencyInput.value;
        const imageInput = document.getElementById('medicineImages');
        const files = imageInput.files;
        
        const timeSlots = Array.from(document.querySelectorAll('.time-slot')).map(slot => {
          const start = slot.querySelector('.startTime').value;
          const end = slot.querySelector('.endTime').value;
          if (!start || !end) {
            alert("Please fill in all time slot fields.");
            return;
          }
          const startM = timeToMinutes(start);
          const endM = timeToMinutes(end);
          const duration = endM - startM;
          if (duration <= 0) {
            alert("End time must be after start time.");
            return;
          }
          const alarmTimes = calculateAlarmTimes(start, end);
          return {
            start,
            end,
            status: "pending",
            alarmTimes,
            alarmsTriggered: [false, false, false]
          };
        }).filter(x => x !== undefined);
        
        const processReminder = (images) => {
          const reminder = {
            id: Date.now(),
            medicineName,
            pillCount,
            frequency,
            timeSlots,
            images
          };
          remindersCG.push(reminder);
          // For demo, share the same reminders with Elder profile
          remindersEL.push(reminder);
          updateCaregiverViews();
          updateElderViews();
          caregiverForm.reset();
          frequencyInput.disabled = false;
          lifetimeCheckbox.checked = false;
          timeSlotsDiv.innerHTML = `<div class="flex space-x-2 items-center time-slot">
            <input type="time" class="startTime rounded-md border-gray-300 shadow-sm" required />
            <span class="self-center">to</span>
            <input type="time" class="endTime rounded-md border-gray-300 shadow-sm" required />
            <button type="button" class="removeTimeSlot bg-red-500 text-white px-2 py-1 rounded hover:bg-red-600">Remove</button>
          </div>`;
        };

        if (files.length > 0) {
          let filePromises = [];
          for (let i = 0; i < files.length; i++) {
            filePromises.push(new Promise((resolve, reject) => {
              const reader = new FileReader();
              reader.onload = function(e) {
                resolve(e.target.result);
              };
              reader.onerror = reject;
              reader.readAsDataURL(files[i]);
            }));
          }
          Promise.all(filePromises).then(images => {
            processReminder(images);
          }).catch(() => {
            alert("Error reading image files.");
          });
        } else {
          processReminder([]);
        }
      });
      
      // Alarm Check for Caregiver Reminders
      setInterval(() => {
        const now = new Date();
        const currentMinutes = now.getHours() * 60 + now.getMinutes();
        remindersCG.forEach(reminder => {
          reminder.timeSlots.forEach(slot => {
            const slotStart = timeToMinutes(slot.start);
            const slotEnd = timeToMinutes(slot.end);
            if (currentMinutes >= slotStart && currentMinutes < slotEnd) {
              slot.alarmTimes.forEach((alarmTime, index) => {
                if (!slot.alarmsTriggered[index] && currentMinutes >= alarmTime) {
                  alert(`Reminder for Elder: Time to take ${reminder.medicineName} (${slot.start} - ${slot.end}) [Alarm ${index+1}]`);
                  slot.alarmsTriggered[index] = true;
                }
              });
            }
            if (currentMinutes >= slotEnd && slot.status === "pending") {
              slot.status = "missed";
              alert(`Alert for Caregiver: Medicine "${reminder.medicineName}" missed for time slot ${slot.start} - ${slot.end}`);
              addLogEntry(`Medicine "${reminder.medicineName}" missed for time slot ${slot.start} - ${slot.end}`);
            }
          });
        });
        updateCaregiverViews();
        updateElderViews();
      }, 1000);
      
      function updateCaregiverViews() {
        const caregiverHTML = remindersCG.map(reminder => `
          <div class="bg-white p-6 rounded-lg shadow-md mb-8">
            <h1 class="text-3xl font-bold text-gray-800">${reminder.medicineName}</h1>
            <p class="text-gray-600">Pills per Dose: ${reminder.pillCount}</p>
            <p class="text-gray-600">Frequency: ${reminder.frequency === "Life" ? "Lifetime" : reminder.frequency + " day(s)"}</p>
          </div>
        `).join('') || '<p class="text-gray-500">No reminders set yet.</p>';
        document.getElementById('caregiverReminders').innerHTML = caregiverHTML;
        updateActivityLog();
      }
      
      function updateElderViews() {
        const elderHTML = remindersEL.map(reminder => `
          <div class="bg-white p-6 rounded-lg shadow-md mb-8">
            <h1 class="text-3xl font-bold text-gray-800">${reminder.medicineName}</h1>
            <p class="text-gray-600">Pills per Dose: ${reminder.pillCount}</p>
            ${ reminder.images && reminder.images.length ? `
              <div class="flex space-x-2 mt-2">
                ${ reminder.images.map(img => `<img src="${img}" class="w-48 h-48 object-contain rounded" />`).join('') }
              </div>
            ` : '' }
            ${ reminder.timeSlots.map((slot, idx) => `
              <div class="mt-2">
                <p class="text-gray-600">${slot.start} - ${slot.end}</p>
                ${ (slot.status === 'pending' || slot.status === 'missed') ? `
                  <button onclick="markTaken(${reminder.id}, ${idx})" class="bg-green-500 text-white px-3 py-1 rounded hover:bg-green-600">
                    Mark as Taken
                  </button>
                ` : '' }
              </div>
            `).join('')}
          </div>
        `).join('') || '<p class="text-gray-500">No reminders available.</p>';
        document.getElementById('elderReminders').innerHTML = elderHTML;
      }
      
      function markTaken(reminderId, slotIndex) {
        console.log(`Marking reminder ${reminderId}, slot ${slotIndex} as taken.`);
        remindersCG = remindersCG.map(reminder => {
          if (reminder.id === reminderId) {
            const slot = reminder.timeSlots[slotIndex];
            if (slot.status === "pending" || slot.status === "missed") {
              const now = new Date();
              const currentMinutes = now.getHours() * 60 + now.getMinutes();
              const slotEnd = timeToMinutes(slot.end);
              const delay = currentMinutes - slotEnd;
              slot.status = delay > 0 
                ? `Taken (${formatDelay(delay)})`
                : 'Taken on time';
              addLogEntry(`Medicine "${reminder.medicineName}" taken ${delay > 0 ? formatDelay(delay) : 'on time'} at ${now.toLocaleTimeString()}`);
            }
          }
          return reminder;
        });
        updateCaregiverViews();
        updateElderViews();
      }
      window.markTaken = markTaken;
    });
    
    // -----------------------
    // Elder Navigation
    // -----------------------
    document.addEventListener('DOMContentLoaded', function() {
      const elderNavButtons = document.querySelectorAll('.elder-nav-btn');
      elderNavButtons.forEach(btn => {
        btn.addEventListener('click', () => {
          const page = btn.getAttribute('data-page');
          document.querySelectorAll('.el-page').forEach(section => section.classList.add('hidden'));
          document.getElementById(page).classList.remove('hidden');
          elderNavButtons.forEach(b => b.classList.remove('bg-green-700'));
          btn.classList.add('bg-green-700');
        });
      });
      // Default Elder Navigation: show Medicine Reminder page
      document.getElementById('elMedicine').classList.remove('hidden');
      document.getElementById('elHome').classList.add('hidden');
      document.getElementById('elSafety').classList.add('hidden');
      document.getElementById('elProfile').classList.add('hidden');
      
      document.getElementById('elLogout').addEventListener('click', () => {
        document.getElementById('elderProfile').classList.add('hidden');
        document.getElementById('landingPage').classList.remove('hidden');
      });
    });
    
    // -----------------------
    // Caregiver Navigation (Internal Pages)
    // -----------------------
    document.addEventListener('DOMContentLoaded', function() {
      const caregiverNavButtons = document.querySelectorAll('.caregiver-nav-btn');
      caregiverNavButtons.forEach(btn => {
        btn.addEventListener('click', () => {
          const page = btn.getAttribute('data-page');
          document.querySelectorAll('.cg-page').forEach(section => section.classList.add('hidden'));
          document.getElementById(page).classList.remove('hidden');
          caregiverNavButtons.forEach(b => b.classList.remove('bg-blue-700'));
          btn.classList.add('bg-blue-700');
        });
      });
      // Default Caregiver Navigation: show Medicine Reminder page
      document.getElementById('cgMedicine').classList.remove('hidden');
      document.getElementById('cgHome').classList.add('hidden');
      document.getElementById('cgSafety').classList.add('hidden');
      document.getElementById('cgProfile').classList.add('hidden');
      
      document.getElementById('cgLogout').addEventListener('click', () => {
        document.getElementById('caregiverProfile').classList.add('hidden');
        document.getElementById('landingPage').classList.remove('hidden');
      });
    });
    
    // -----------------------
    // Landing Page Profile Selection
    // -----------------------
    document.addEventListener('DOMContentLoaded', function() {
      document.getElementById('selectCaregiver').addEventListener('click', () => {
        document.getElementById('landingPage').classList.add('hidden');
        document.getElementById('caregiverProfile').classList.remove('hidden');
      });
      document.getElementById('selectElder').addEventListener('click', () => {
        document.getElementById('landingPage').classList.add('hidden');
        document.getElementById('elderProfile').classList.remove('hidden');
      });
    });
  </script>
</body>
</html>
